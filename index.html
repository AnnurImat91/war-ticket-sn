<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>War Tiket Badminton SUka Nepak</title>
    <link
      rel="icon"
      type="image/x-icon"
      href="img/logo-removebg-preview - Copy.png"
    />
    <!-- Font New Year: Cinzel (Mewah) & Montserrat (Modern) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root {
        /* Palet Warna New Year */
        --ny-gold: #d4af37;          /* Metallic Gold */
        --ny-gold-light: #f7e7ce;    /* Champagne */
        --ny-dark: #0f172a;          /* Midnight Blue/Black */
        --ny-black: #000000;
        --ny-accent: #ff4d4d;        /* Firework Red */
        --glass-bg: rgba(20, 20, 30, 0.85);
        
        --glow-gold: 0 0 15px rgba(212, 175, 55, 0.5);
      }

      body {
        font-family: 'Montserrat', sans-serif;
        background-color: var(--ny-black);
        /* Background Fireworks Gradient sederhana */
        background-image: 
          radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.15) 0%, transparent 20%),
          radial-gradient(circle at 80% 10%, rgba(255, 77, 77, 0.15) 0%, transparent 20%),
          radial-gradient(circle at 50% 80%, rgba(100, 200, 255, 0.1) 0%, transparent 30%);
        background-attachment: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
        color: var(--ny-gold-light);
        overflow-x: hidden;
      }

      /* Animasi 'Sparkle' Background */
      @keyframes twinkle {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 1; transform: scale(1.2); }
      }

      .star {
        position: absolute;
        width: 3px;
        height: 3px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 0 5px white;
        animation: twinkle 2s infinite ease-in-out;
      }

      .card {
        background: var(--glass-bg);
        width: 100%;
        max-width: 420px;
        padding: 2.5rem 2rem;
        border-radius: 16px;
        /* Border Emas Mewah */
        border: 1px solid var(--ny-gold);
        box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(212, 175, 55, 0.1);
        text-align: center;
        position: relative;
        backdrop-filter: blur(10px);
        z-index: 10;
      }

      /* Dekorasi Pita Tahun Baru */
      .card::before {
        content: 'üéä 2026 üéä';
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(90deg, var(--ny-gold), #f9d976, var(--ny-gold));
        color: var(--ny-dark);
        padding: 5px 20px;
        font-weight: 800;
        border-radius: 50px;
        font-size: 0.9rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        border: 2px solid #fff;
      }

      img {
        margin-top: 15px;
        /* Filter emas pada logo */
        filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
        transition: transform 0.5s ease;
      }
      
      img:hover {
        transform: scale(1.1) rotate(10deg);
      }

      h1 {
        font-family: 'Cinzel', serif;
        margin: 20px 0 25px 0;
        font-size: 2rem;
        font-weight: 700;
        /* Teks Emas Gradient */
        background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        letter-spacing: 2px;
      }
      
      h1 span {
        font-family: 'Montserrat', sans-serif;
        font-size: 0.8rem;
        color: var(--ny-gold-light);
        display: block;
        margin-top: 8px;
        letter-spacing: 4px;
        text-transform: uppercase;
        font-weight: 400;
        background: none;
        -webkit-text-fill-color: var(--ny-gold-light);
      }

      #loadingCheck {
        color: var(--ny-gold);
        border: 1px solid var(--ny-gold);
        padding: 8px 20px;
        border-radius: 4px;
        display: inline-block;
        font-size: 0.8rem;
        letter-spacing: 1px;
        text-transform: uppercase;
        background: rgba(0,0,0,0.3);
      }

      .alert-box {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-left: 3px solid var(--ny-gold);
        color: var(--ny-gold-light);
        padding: 15px;
        font-size: 0.9rem;
        margin-bottom: 1.5rem;
        text-align: left;
        line-height: 1.5;
        border-radius: 0 8px 8px 0;
      }

      .quota-display {
        background: rgba(0,0,0,0.4);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .quota-display span {
        display: block;
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .quota-number {
        display: inline-block;
        font-family: 'Cinzel', serif;
        font-size: 3.5rem;
        color: var(--ny-gold);
        font-weight: 700;
        text-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
      }

      input {
        width: 100%;
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid #444;
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
        margin-bottom: 1.2rem;
        box-sizing: border-box;
        transition: 0.3s;
        outline: none;
        text-align: center;
      }

      input:focus {
        border-color: var(--ny-gold);
        background-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
      }
      
      input::placeholder {
        color: #666;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
      }

      button {
        width: 100%;
        padding: 16px;
        color: var(--ny-dark);
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-family: 'Montserrat', sans-serif;
        font-weight: 800;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn-main {
        /* Gradient Emas */
        background: linear-gradient(45deg, #b38728, #fcf6ba, #aa771c);
        background-size: 200% auto;
        box-shadow: 0 4px 15px rgba(179, 135, 40, 0.4);
      }
      
      .btn-main:hover {
        background-position: right center;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(179, 135, 40, 0.6);
      }

      .btn-wl {
        background: #333;
        color: #888;
        border: 1px solid #555;
      }

      .btn-wl:hover {
        background: #444;
        color: white;
      }

      button:disabled {
        background: #222;
        color: #555;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      #status {
        margin-top: 1.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .text-success { color: #4ade80; text-shadow: 0 0 10px rgba(74, 222, 128, 0.3); }
      .text-error { color: #ff4d4d; text-shadow: 0 0 10px rgba(255, 77, 77, 0.3); }
      .text-wl { color: #facc15; }

      .hidden {
        display: none !important;
      }
      
      .footer-note {
        margin-top: 25px;
        font-size: 0.7rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      
      /* Fireworks decorations */
      .fw-deco {
        position: fixed;
        font-size: 2rem;
        opacity: 0.2;
        animation: burst 2s infinite ease-out;
        z-index: 0;
        pointer-events: none;
      }
      
      @keyframes burst {
        0% { transform: scale(0.5); opacity: 0; }
        50% { opacity: 0.4; }
        100% { transform: scale(1.5); opacity: 0; }
      }

      /* --- STYLE TABEL NEW YEAR --- */
      .list-container {
        margin-top: 2rem;
        border-top: 1px solid rgba(255,215,0,0.3);
        padding-top: 1.5rem;
      }
      
      h3 {
        margin: 0 0 1rem 0;
        font-family: 'Cinzel', serif;
        font-size: 1.1rem;
        color: var(--ny-gold);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .table-scroll {
        max-height: 250px;
        overflow-y: auto;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        background: rgba(0,0,0,0.2);
        
        /* Custom Scrollbar Dark */
        scrollbar-width: thin;
        scrollbar-color: var(--ny-gold-dark) var(--ny-black);
      }
      
      .table-scroll::-webkit-scrollbar {
        width: 8px;
      }
      .table-scroll::-webkit-scrollbar-track {
        background: var(--ny-black);
      }
      .table-scroll::-webkit-scrollbar-thumb {
        background-color: var(--ny-gold-dark);
        border-radius: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      
      th {
        background: rgba(184, 134, 11, 0.2); /* Dark Gold tint */
        padding: 12px 10px;
        text-align: left;
        font-weight: 700;
        color: var(--ny-gold);
        position: sticky;
        top: 0;
        border-bottom: 1px solid rgba(255,215,0,0.3);
        text-transform: uppercase;
        font-family: 'Cinzel', serif;
        letter-spacing: 1px;
        backdrop-filter: blur(5px);
      }
      
      td {
        padding: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        color: var(--ny-silver);
      }
      
      tr:nth-child(even) {
        background-color: rgba(255,255,255,0.02);
      }
      
      tr:hover {
        background-color: rgba(255,215,0,0.05);
      }

      /* Badge Status Neon */
      .badge-ok {
        background: rgba(0, 255, 136, 0.1);
        color: var(--success-glow);
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        border: 1px solid rgba(0, 255, 136, 0.3);
        box-shadow: 0 0 5px rgba(0, 255, 136, 0.2);
      }
      
      .badge-wl {
        background: rgba(255, 204, 0, 0.1);
        color: var(--wl-glow);
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        border: 1px solid rgba(255, 204, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <!-- Efek Partikel Background -->
    <div class="star" style="top: 10%; left: 20%; animation-delay: 0s;"></div>
    <div class="star" style="top: 30%; left: 80%; animation-delay: 0.5s;"></div>
    <div class="star" style="top: 70%; left: 10%; animation-delay: 1s;"></div>
    <div class="star" style="top: 50%; left: 50%; animation-delay: 1.5s;"></div>
    
    <div class="fw-deco" style="top: 15%; left: 15%; color: gold;">üí•</div>
    <div class="fw-deco" style="top: 25%; right: 15%; color: red; animation-delay: 0.8s;">üí•</div>

    <div class="card">
      <img
        src="img/logo-removebg-preview - Copy.png"
        alt="Logo"
        style="height: 100px"
        onerror="this.style.display='none'" 
      />
      
      <h1>WAR TIKET<br><span>Edisi Tahun Baru</span></h1>

      <div id="loadingCheck">Checking Availability...</div>

      <div id="quotaSection" class="hidden">
        <div class="quota-display">
          <span>Sisa Slot</span>
          <div id="slotNumber" class="quota-number">-</div>
        </div>
        <div class="alert-box">
          ü•Ç <b>Perhatian:</b><br>
          Jika slot habis, Anda akan masuk ke Waiting List prioritas.
        </div>
      </div>

      <div id="formSection">
        <input
          type="text"
          id="nama"
          placeholder="Nama Peserta"
          autocomplete="off"
        />
        <button id="btnSubmit" class="btn-main" onclick="submitData()">
          Amankan Slot 2026
        </button>
      </div>

      <div id="status"></div>
      
      <div class="list-container">
        <h3>üìã Daftar Peserta Live</h3>
        <div class="table-scroll">
          <table id="tabelPeserta">
            <thead>
              <tr>
                <th style="width: 15%">#</th>
                <th style="width: 50%">Nama</th>
                <th style="width: 35%">Status</th>
              </tr>
            </thead>
            <tbody id="tabelBody">
              <tr>
                <td colspan="3" style="text-align: center; color: #888; padding: 20px;">
                  Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
    </div>

    <script>
      // ================= KONFIGURASI =================
      const API_BASE_URL = "https://sheetdb.io/api/v1/ct6zpfwtg0d2r"; // GANTI API ANDA
      // ===============================================

      // 1. FUNGSI LOGIKA OTOMATIS (AUTO-SCHEDULE)
      function getAutoSchedule() {
        const now = new Date();
        const day = now.getDay();
        let targetDate = new Date(now);
        let sesiName = "";

        // --- PERBAIKAN LOGIKA HARI DI SINI ---
        if (day >= 1 && day <= 4) {
          // Senin(1) s/d Kamis(4) --> Target Kamis
          const selisih = 4 - day;
          targetDate.setDate(now.getDate() + selisih);
          sesiName = "kamis";
        } else if (day === 5 || day === 6) {
          // Jumat(5) & Sabtu(6) --> Target Sabtu
          // (Kode lama Anda salah karena tidak ada angka 5)
          const selisih = 6 - day;
          targetDate.setDate(now.getDate() + selisih);
          sesiName = "sabtu";
        } else {
          // Minggu(0) --> Target Kamis Depan
          targetDate.setDate(now.getDate() + 3);
          sesiName = "kamis";
        }

        const tgl = targetDate.getDate().toString().padStart(2, "0");
        const bln = (targetDate.getMonth() + 1).toString().padStart(2, "0");
        const thn = targetDate.getFullYear();

        // GENERATOR KODE ACAK TAPI KONSISTEN
        // Agar kode tidak berupa tanggal polos, tapi karakter unik
        const dateNum = parseInt(`${thn}${bln}${tgl}`);
        const saltMath = 13579;
        const randomLook = (dateNum * saltMath)
          .toString(36)
          .toUpperCase()
          .slice(-6);

        // Hasil: KAMIS-7X92BQ
        const autoKode = `${sesiName.toUpperCase()}-${randomLook}`;

        return {
          sesi: sesiName,
          generatedKode: autoKode, // Pastikan nama variabel ini konsisten
          dateReadable: `${tgl}/${bln}/${thn}`,
        };
      }

      // 2. INISIALISASI VARIABEL
      const urlParams = new URLSearchParams(window.location.search);
      let sesiParam = urlParams.get("sesi");
      let kodeParam = urlParams.get("generatedKode");
      let displayTanggal = "";

      // JIKA LINK POLOS (Tidak ada parameter), GUNAKAN AUTO-SCHEDULE
      if (!sesiParam || !kodeParam) {
        console.log("Link polos dideteksi, menjalankan Auto-Schedule...");
        const auto = getAutoSchedule();
        sesiParam = auto.sesi;
        kodeParam = auto.generatedKode;
        displayTanggal = auto.dateReadable;

        // Opsional: Ubah URL di browser biar user tau (tanpa reload)
        const newUrl = `${window.location.pathname}?sesi=${sesiParam}&kode=${kodeParam}`;
        
        // DIBUNGKUS TRY-CATCH UNTUK MENGHINDARI ERROR DI BLOB/SANDBOX
        try {
            window.history.replaceState(null, "", newUrl);
        } catch (e) {
            console.warn("Tidak dapat update URL history (Environment sandbox/blob):", e);
        }
      }

      // Variabel Global
      let maxQuota = 0;
      let targetSheet = "";
      let currentTotal = 0;

      // 3. VALIDASI SESI
      if (sesiParam === "kamis") {
        maxQuota = 12;
        targetSheet = "Kamis";
      } else if (sesiParam === "sabtu") {
        maxQuota = 26;
        targetSheet = "Sabtu";
      } else {
        document.getElementById("formSection").innerHTML =
          '<p class="text-error">Error: Sesi tidak dikenali.</p>';
        document.getElementById("loadingCheck").style.display = "none";
      }

      const BASE_ENDPOINT = `${API_BASE_URL}?sheet=${targetSheet}`;

      // Helper text cleaner
      // Helper: Membersihkan teks agar pencocokan akurat (Anti Spasi & Huruf Besar/Kecil)
      function cleanText(str) {
        return str ? str.toString().trim().toUpperCase() : "";
      }

      // 4. FUNGSI LOAD DATA (INIT)
      async function init() {
        if (!maxQuota) return;

        // Update Judul
        const titleInfo = displayTanggal ? ` (${displayTanggal})` : "";
        document.querySelector(
          "h1 span"
        ).innerHTML = `${targetSheet.toUpperCase()}${titleInfo}`;

        try {
          const uniq = new Date().getTime();
          const fetchUrl = `${BASE_ENDPOINT}&uniq=${uniq}`;
          const response = await fetch(fetchUrl);
          const data = await response.json();

          const targetKode = cleanText(kodeParam);

          // --- PERBAIKAN DI SINI ---
          // Kita cek item.Sesi_Kode (sesuai payload) ATAU item.sesi_kode (jaga-jaga)
          const validData = data.filter(
            (item) => cleanText(item.Sesi_Kode || item.sesi_kode) === targetKode
          );

          currentTotal = validData.length;
          const sisa = Math.max(0, maxQuota - currentTotal);

          document.getElementById("loadingCheck").classList.add("hidden");
          document.getElementById("quotaSection").classList.remove("hidden");
          document.getElementById("slotNumber").innerText = sisa;

          updateButtonState();

          console.log(
            "Kode:",
            targetKode,
            "| Terisi:",
            currentTotal,
            "| Sisa:",
            sisa
          );
        } catch (error) {
          console.error(error);
          document.getElementById("status").innerHTML = "Gagal koneksi server.";
        }
        refreshTable(); // <--- Render tabel di awal
      }

      function updateButtonState() {
        const btn = document.getElementById("btnSubmit");
        if (currentTotal >= maxQuota) {
          btn.className = "btn-wl";
          btn.innerText = "ANTRI WAITING LIST";
        } else {
          btn.className = "btn-main";
          btn.innerText = "AMANKAN SLOT!";
        }
      }

      // Jalankan fungsi refresh table (agar tabel tetap muncul meskipun quota error)
      refreshTable(); 
      if (maxQuota) init();

      // 5. FUNGSI SUBMIT
      async function submitData() {
        const nama = document.getElementById("nama").value;
        const btn = document.getElementById("btnSubmit");
        const status = document.getElementById("status");

        if (!nama) {
          alert("Isi nama dulu!");
          return;
        }

        btn.disabled = true;
        btn.innerText = "Sedang Menyimpan...";
        status.innerHTML = "";

        try {
          // Double Check Kuota Real-time
          const uniq = new Date().getTime();
          const checkRes = await fetch(`${BASE_ENDPOINT}&uniq=${uniq}`);
          const checkData = await checkRes.json();

          const targetKode = cleanText(kodeParam);

          // --- PERBAIKAN DI SINI JUGA ---
          const realtimeCount = checkData.filter(
            (item) => cleanText(item.Sesi_Kode || item.sesi_kode) === targetKode
          ).length;

          let isWL = false;
          let urutanWL = 0;
          let pesan = "";

          if (realtimeCount >= maxQuota) {
            isWL = true;
            urutanWL = realtimeCount - maxQuota + 1;
            pesan = `Yah telat! Masuk <b>Waiting List ke-${urutanWL}</b>.`;
          } else {
            pesan = `<b>BERHASIL!</b> Slot diamankan.`;
          }

          const now = new Date();
          // Payload dikirim dengan huruf Besar Awal (PascalCase)
          const payload = {
            data: {
              ID: "INCREMENT",
              Tanggal: now.toLocaleDateString("id-ID"),
              Timestamp: now.toLocaleTimeString("id-ID"),
              Nama: nama,
              Sesi_Kode: kodeParam, // Pastikan ini sama dengan filter di atas
            },
          };

          const postRes = await fetch(BASE_ENDPOINT, {
            method: "POST",
            headers: {
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const result = await postRes.json();

          if (result.created) {
            status.innerHTML = `<span class='${
              isWL ? "text-wl" : "text-success"
            }'>${pesan}</span>`;
            document.getElementById("nama").disabled = true;
            btn.classList.add("hidden");

            // Update UI Sisa Slot secara lokal agar instan
            if (!isWL) {
              document.getElementById("slotNumber").innerText =
                maxQuota - (realtimeCount + 1);
            } else {
              document.getElementById("slotNumber").innerText = "0";
            }
          } else {
            throw new Error("Gagal respon server");
          }
        } catch (error) {
          status.innerHTML =
            "<span class='text-error'>Error: " + error.message + "</span>";
          btn.disabled = false;
          updateButtonState();
        }
        refreshTable(); // <--- Update tabel realtime setelah submit
      }

      // 6. FUNGSI RENDER TABEL REAL-TIME
      async function refreshTable() {
        const tbody = document.getElementById("tabelBody");

        // Jika variabel penting belum siap, jangan jalan dulu
        if (!targetSheet || !kodeParam) return;

        try {
          // Anti-cache url
          const uniq = new Date().getTime();
          const endpoint = `${API_BASE_URL}?sheet=${targetSheet}&uniq=${uniq}`;

          const response = await fetch(endpoint);
          const data = await response.json();

          // Filter data sesuai kode sesi URL
          const targetKode = cleanText(kodeParam);
          const validData = data.filter(
            (item) => cleanText(item.Sesi_Kode || item.sesi_kode) === targetKode
          );

          // Reset isi tabel
          tbody.innerHTML = "";

          if (validData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:15px; color:#aaa;">Belum ada peserta. Jadilah yang pertama!</td></tr>`;
            return;
          }

          // Loop data untuk ditampilkan
          validData.forEach((item, index) => {
            const row = document.createElement("tr");
            const nomor = index + 1; // Urutan (1, 2, 3...)

            // Logika Status (Masuk vs WL)
            let statusBadge = "";
            if (nomor <= maxQuota) {
              statusBadge = `<span class="badge-ok">‚úÖ MASUK</span>`;
            } else {
              const urutanWL = nomor - maxQuota;
              statusBadge = `<span class="badge-wl">‚è≥ WL-${urutanWL}</span>`;
            }

            // Sanitasi Nama (Biar aman dari script jahat)
            const safeName = item.Nama
              ? item.Nama.replace(/</g, "&lt;").replace(/>/g, "&gt;")
              : "Tanpa Nama";

            row.innerHTML = `
                <td style="font-weight:bold; color:var(--ny-gold);">${nomor}</td>
                <td>${safeName}</td>
                <td>${statusBadge}</td>
            `;
            tbody.appendChild(row);
          });
        } catch (error) {
          console.error("Gagal load tabel:", error);
          tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">Gagal memuat tabel.</td></tr>`;
        }
      }
    </script>
  </body>
</html>


